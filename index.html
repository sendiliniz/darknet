<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DarkNet Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.22.9/babel.min.js"></script>
</head>
<body class="bg-gradient-to-b from-gray-900 to-gray-800">
  <div id="root" class="min-h-screen text-gray-100"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const socket = io('http://localhost:3000');

    const getAvatar = (username) => {
      const emojis = ['😺', '🦊', '🐶', '🐻', '🐼', '🦁', '🐸', '🦄'];
      let hash = 0;
      for (let i = 0; i < username.length; i++) {
        hash = username.charCodeAt(i) + ((hash << 5) - hash);
      }
      return emojis[Math.abs(hash) % emojis.length];
    };

    const App = () => {
      const [username, setUsername] = useState('');
      const [message, setMessage] = useState('');
      const [messages, setMessages] = useState([]);
      const [isConnected, setIsConnected] = useState(false);
      const [error, setError] = useState('');
      const [isJoining, setIsJoining] = useState(false);
      const fileInputRef = useRef(null);

      useEffect(() => {
        socket.on('connect', () => {
          console.log('Connected to server');
        });

        socket.on('usernameTaken', () => {
          setError('Username is already taken');
          setIsJoining(false);
          socket.disconnect();
        });

        socket.on('joined', () => {
          setIsConnected(true);
          setIsJoining(false);
          setError('');
        });

        socket.on('message', (msg) => {
          setMessages((prev) => [...prev, msg]);
        });

        socket.on('error', (err) => {
          setError(err);
          setIsJoining(false);
        });

        return () => {
          socket.off('connect');
          socket.off('usernameTaken');
          socket.off('joined');
          socket.off('message');
          socket.off('error');
        };
      }, []);

      const handleJoin = (e) => {
        e.preventDefault();
        if (username.trim() && !isJoining) {
          setIsJoining(true);
          socket.connect();
          socket.emit('join', username.trim().toLowerCase());
        }
      };

      const handleSendMessage = (e) => {
        e.preventDefault();
        if (message.trim()) {
          socket.emit('message', { username, text: message, type: 'text' });
          setMessage('');
        }
      };

      const handleFileUpload = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const maxSize = 5 * 1024 * 1024; // 5MB
        if (file.size > maxSize) {
          setError('File size exceeds 5MB limit');
          return;
        }

        const validImageTypes = ['image/png', 'image/jpeg', 'image/gif', 'video/mp4', 'video/webm'];
        if (!validImageTypes.includes(file.type)) {
          setError('Invalid file type. Use PNG, JPEG, GIF, MP4, or WEBM');
          return;
        }

        const reader = new FileReader();
        reader.onload = () => {
          socket.emit('message', {
            username,
            type: file.type.startsWith('image/') ? 'image' : 'video',
            data: reader.result,
          });
          fileInputRef.current.value = '';
        };
        reader.onerror = () => setError('Failed to read file');
        reader.readAsDataURL(file);
      };

      if (!isConnected) {
        return (
          <div className="flex items-center justify-center min-h-screen px-4">
            <form onSubmit={handleJoin} className="p-8 bg-gray-800/80 rounded-xl shadow-2xl backdrop-blur-sm w-full max-w-md transform transition-all duration-300">
              <h1 className="text-3xl font-bold mb-6 text-center bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-blue-500">
                Join DarkNet
              </h1>
              <input
                type="text"
                value={username}
                onChange={(e) => setUsername(e.target.value)}
                placeholder="Choose a username"
                className="w-full p-3 mb-4 bg-gray-900/50 rounded-lg border border-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all duration-200"
                disabled={isJoining}
              />
              {error && <p className="text-red-400 mb-4 text-center">{error}</p>}
              <button
                type="submit"
                className={`w-full p-3 rounded-lg font-semibold transition-all duration-200 ${
                  isJoining
                    ? 'bg-gray-600 cursor-not-allowed'
                    : 'bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700'
                }`}
                disabled={isJoining}
              >
                {isJoining ? 'Joining...' : 'Enter Chat'}
              </button>
            </form>
          </div>
        );
      }

      return (
        <div className="flex flex-col h-screen max-w-4xl mx-auto">
          <h1 className="text-2xl font-bold p-4 bg-gray-800/80 backdrop-blur-sm sticky top-0 z-10 bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-blue-500">
            DarkNet Chat
          </h1>
          <div className="flex-1 p-4 overflow-y-auto bg-gray-900/50">
            {messages.map((msg, index) => (
              <div
                key={index}
                className="mb-3 p-3 bg-gray-800/50 rounded-lg flex items-start space-x-3 hover:bg-gray-800/70 transition-all duration-200"
              >
                <span className="text-2xl">{getAvatar(msg.username)}</span>
                <div className="flex-1">
                  <span className="font-semibold text-purple-300">{msg.username}</span>
                  {msg.type === 'text' && <p className="text-gray-200">{msg.text}</p>}
                  {msg.type === 'image' && (
                    <img
                      src={msg.data}
                      alt="Uploaded image"
                      className="mt-2 max-w-xs rounded-lg shadow-md"
                    />
                  )}
                  {msg.type === 'video' && (
                    <video
                      src={msg.data}
                      controls
                      className="mt-2 max-w-xs rounded-lg shadow-md"
                    />
                  )}
                </div>
              </div>
            ))}
          </div>
          <form onSubmit={handleSendMessage} className="p-4 bg-gray-800/80 sticky bottom-0">
            <div className="flex space-x-2">
              <input
                type="text"
                value={message}
                onChange={(e) => setMessage(e.target.value)}
                placeholder="Type a message..."
                className="flex-1 p-3 bg-gray-900/50 rounded-lg border border-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all duration-200"
              />
              <label className="p-3 bg-gray-900/50 rounded-lg border border-gray-700 hover:bg-gray-700 transition-all duration-200 cursor-pointer">
                <span className="text-gray-400">📎</span>
                <input
                  type="file"
                  accept="image/png,image/jpeg,image/gif,video/mp4,video/webm"
                  onChange={handleFileUpload}
                  className="hidden"
                  ref={fileInputRef}
                />
              </label>
              <button
                type="submit"
                className="p-3 bg-gradient-to-r from-purple-600 to-blue-600 rounded-lg hover:from-purple-700 hover:to-blue-700 transition-all duration-200 font-semibold"
              >
                Send
              </button>
            </div>
          </form>
        </div>
      );
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
